# Unzip bz2 files
bunzip2 /Users/albertolupatin/Desktop/Genomics/Project/*.bz2

mkdir Samples
mv *.fna Samples


# Quality Checking - CheckM
conda activate checkm
checkm taxonomy_wf domain Bacteria Samples checkm_output -t 4


# Taxonomic Alignment - PhyloPhlan
conda deactivate && conda activate ppa
phylophlan_metagenomic -i /Users/albertolupatin/Desktop/Genomics/Project/SGB1566/Samples -e ".fna" -d CMG2324 --database_folder ppa_db --nproc 8 --verbose -n 1 | tee ppa_project.log


# Genome Annotation - Prokka
conda deactivate && conda activate prokka
 for i in $(ls *.fna); do
      prokka --outdir ${i//.fna} --prefix ${i//.fna} $i --compliant;
done


# Pangenome Analysis - Roary
conda deactivate && conda activate roary
mkdir roary_input
cd roary_input
ln -s /Users/albertolupatin/Desktop/Genomics/Project/Prokka/M*/*.gff ./

roary -e --mafft -p 8 -f ../roary_output *.gff

chmod +x create_pan_genome_plots.R
Rscript create_pan_genome_plots.R


# Phylogenetic Analysis - FastTree
FastTreeMP -pseudo -spr 4 -mlacc 2 -slownni -fastest -no2nd -mlnni 4 -gtr -nt -out         \
/Users/albertolupatin/Desktop/Genomics/Project/FastTree/core_gene_phylogeny.nwk /Users/albertolupatin/Desktop/Genomics/Project/Roary/roary_output/core_gene_alignment.aln
